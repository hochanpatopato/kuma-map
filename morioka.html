<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç†Šå‡ºæ²¡ãƒŠãƒ“ï½œå²©æ‰‹çœŒ ç››å²¡å¸‚</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="å²©æ‰‹çœŒç››å²¡å¸‚ã®ç†Šå‡ºæ²¡ãƒ»ç›®æ’ƒæƒ…å ±ã‚’åœ°å›³ã§ç¢ºèª">

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family: system-ui, sans-serif; }
#map { width:100%; height:100%; }

.ui {
  position: fixed;
  background: rgba(255,255,255,0.92);
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 13px;
  z-index: 10;
}

#city {
  top: 12px;
  left: 12px;
}

#counter {
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  font-weight: bold;
}

#legend {
  bottom: 12px;
  left: 12px;
}

#note {
  bottom: 12px;
  right: 12px;
  max-width: 280px;
  font-size: 12px;
}

#areaSelector {
  top: 60px;
  left: 12px;
  max-width: 150px;
}
#areaSelector .title {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 12px;
  color: #64748b;
}
#areaSelector a {
  display: block;
  padding: 8px 10px;
  margin: 4px 0;
  background: #f8fafc;
  border-radius: 6px;
  text-decoration: none;
  color: #334155;
  font-size: 13px;
  transition: all 0.2s;
}
#areaSelector a:hover {
  background: #e2e8f0;
}
#areaSelector a.active {
  background: #3b82f6;
  color: white;
  font-weight: bold;
}

/* æœˆåˆ¥ã‚°ãƒ©ãƒ• */
#monthChart {
  bottom: 350px;
  left: 12px;
  max-width: 340px;
  max-height: 180px;
}
#monthChart .title {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 12px;
  color: #64748b;
}
#monthChart .chart {
  display: flex;
  align-items: flex-end;
  gap: 6px;
  height: 120px;
  padding: 8px 0;
}
#monthChart .bar-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}
#monthChart .bars {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  gap: 1px;
}
#monthChart .bar {
  width: 100%;
  border-radius: 2px;
  transition: opacity 0.2s;
}
#monthChart .bar.sighting {
  background: #3b82f6;
}
#monthChart .bar.damage {
  background: #ef4444;
}
#monthChart .month-label {
  font-size: 10px;
  color: #94a3b8;
  margin-top: 4px;
}

/* æœˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ */
#monthFilter {
  bottom: 110px;
  left: 12px;
  max-width: 340px;
}
#monthFilter .title {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 12px;
  color: #64748b;
}
#monthFilter .buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}
#monthFilter button {
  padding: 6px 8px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  color: #334155;
}
#monthFilter button:hover {
  background: #e2e8f0;
}
#monthFilter button.active {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
  font-weight: bold;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="city" class="ui">
  å²©æ‰‹çœŒ ç››å²¡å¸‚
</div>

<div id="counter" class="ui">
  è¢«å®³ <span id="damageCount">0</span>ä»¶ ï¼
  ç›®æ’ƒ <span id="sightingCount">0</span>ä»¶
</div>

<div id="areaSelector" class="ui">
  <div class="title">ã‚¨ãƒªã‚¢é¸æŠ</div>
  <a href="index.html">å²©æ‰‹çœŒ å…¨ä½“</a>
  <a href="miyako.html">å®®å¤å¸‚</a>
  <a href="morioka.html" class="active">ç››å²¡å¸‚</a>
</div>

<!-- æœˆåˆ¥ã‚°ãƒ©ãƒ• -->
<div id="monthChart" class="ui">
  <div class="title">æœˆåˆ¥å‚¾å‘</div>
  <div class="chart" id="chartBars"></div>
</div>

<!-- æœˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ -->
<div id="monthFilter" class="ui">
  <div class="title">æœˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿</div>
  <div class="buttons">
    <button data-month="all" class="active">å…¨æœŸé–“</button>
    <button data-month="1">1æœˆ</button>
    <button data-month="2">2æœˆ</button>
    <button data-month="3">3æœˆ</button>
    <button data-month="4">4æœˆ</button>
    <button data-month="5">5æœˆ</button>
    <button data-month="6">6æœˆ</button>
    <button data-month="7">7æœˆ</button>
    <button data-month="8">8æœˆ</button>
    <button data-month="9">9æœˆ</button>
    <button data-month="10">10æœˆ</button>
    <button data-month="11">11æœˆ</button>
    <button data-month="12">12æœˆ</button>
  </div>
</div>

<div id="legend" class="ui">
  <div><span style="color:#ef4444">â—</span> è¢«å®³</div>
  <div><span style="color:#3b82f6">â—</span> ç›®æ’ƒ</div>
</div>

<div id="note" class="ui">
  â€» æœ¬ã‚µã‚¤ãƒˆã¯è‡ªæ²»ä½“ç­‰ãŒå…¬é–‹ã—ã¦ã„ã‚‹æƒ…å ±ã‚’ã‚‚ã¨ã«ã—ãŸå‚è€ƒè¡¨ç¤ºã§ã™ã€‚  
  æœ€æ–°æƒ…å ±ã¯å¿…ãšå…¬å¼ç™ºè¡¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
</div>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ï¼ˆç››å²¡å¸‚ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼‰ ===== */
/* ã“ã“ã«ç››å²¡å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ */
const locations = [
{ lat: 39.7429, lng: 141.1496, title: "ï½œå²©æ‰‹çœŒç››å²¡å¸‚ï½œè¢«å®³ï½œ2025-06-30" },
{ lat: 39.7056, lng: 141.0885, title: "ï½œå²©æ‰‹çœŒç››å²¡å¸‚ï½œè¢«å®³ï½œ2025-10-12" },
{ lat: 39.6864, lng: 141.0598, title: "ï½œå²©æ‰‹çœŒç››å²¡å¸‚ï½œè¢«å®³ï½œ2020-09-04" },
{ lat: 39.6502, lng: 141.2107, title: "ï½œå²©æ‰‹çœŒç››å²¡å¸‚ï½œè¢«å®³ï½œ2019-05-14" },
{ lat: 39.7268, lng: 141.1874, title: "ï½œå²©æ‰‹çœŒç››å²¡å¸‚ï½œè¢«å®³ï½œ2018-07-12" }
];

/* ===== æœˆã‚’æŠ½å‡ºã™ã‚‹é–¢æ•° ===== */
function getMonthFromTitle(title) {
  const parts = title.split("ï½œ");
  if (parts.length >= 4) {
    const dateStr = parts[3];
    const month = parseInt(dateStr.split("-")[1], 10);
    return month;
  }
  return null;
}

/* ===== é›†è¨ˆé–¢æ•°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¯¾å¿œï¼‰ ===== */
function updateCounts(filteredData) {
  const damageCount = filteredData.filter(l => l.title.includes("è¢«å®³")).length;
  const sightingCount = filteredData.filter(l => l.title.includes("ç›®æ’ƒ")).length;
  document.getElementById("damageCount").textContent = damageCount;
  document.getElementById("sightingCount").textContent = sightingCount;
}

/* ===== æœˆåˆ¥é›†è¨ˆã¨ã‚°ãƒ©ãƒ•æç”» ===== */
function drawMonthChart() {
  const monthData = {};
  for (let i = 1; i <= 12; i++) {
    monthData[i] = { sighting: 0, damage: 0 };
  }
  
  locations.forEach(l => {
    const month = getMonthFromTitle(l.title);
    if (month) {
      if (l.title.includes("è¢«å®³")) {
        monthData[month].damage++;
      } else {
        monthData[month].sighting++;
      }
    }
  });
  
  const chartContainer = document.getElementById("chartBars");
  const maxCount = Math.max(...Object.values(monthData).map(d => d.sighting + d.damage));
  
  chartContainer.innerHTML = "";
  
  for (let i = 1; i <= 12; i++) {
    const total = monthData[i].sighting + monthData[i].damage;
    const sightingHeight = maxCount > 0 ? (monthData[i].sighting / maxCount) * 100 : 0;
    const damageHeight = maxCount > 0 ? (monthData[i].damage / maxCount) * 100 : 0;
    
    const barGroup = document.createElement("div");
    barGroup.className = "bar-group";
    barGroup.innerHTML = `
      <div class="bars">
        ${monthData[i].damage > 0 ? `<div class="bar damage" style="height: ${damageHeight}px;" title="è¢«å®³ ${monthData[i].damage}ä»¶"></div>` : ''}
        ${monthData[i].sighting > 0 ? `<div class="bar sighting" style="height: ${sightingHeight}px;" title="ç›®æ’ƒ ${monthData[i].sighting}ä»¶"></div>` : ''}
      </div>
      <div class="month-label">${i}æœˆ</div>
    `;
    chartContainer.appendChild(barGroup);
  }
}

/* ===== åˆæœŸé›†è¨ˆ ===== */
updateCounts(locations);
drawMonthChart();

/* ===== åœ°å›³ï¼ˆç››å²¡å¸‚ä¸­å¿ƒï¼‰ ===== */
const map = new maplibregl.Map({
  container: "map",
  style: "https://demotiles.maplibre.org/style.json",
  center: [141.1527, 39.7036],
  zoom: 11
});

let currentMonth = "all";

map.on("load", () => {
  const geojson = {
    type: "FeatureCollection",
    features: locations.map(l => ({
      type: "Feature",
      properties: {
        isDamage: l.title.includes("è¢«å®³"),
        month: getMonthFromTitle(l.title)
      },
      geometry: {
        type: "Point",
        coordinates: [l.lng, l.lat]
      }
    }))
  };

  map.addSource("bears", {
    type: "geojson",
    data: geojson,
    cluster: true,
    clusterRadius: 50
  });

  map.addLayer({
    id: "clusters",
    type: "circle",
    source: "bears",
    filter: ["has", "point_count"],
    paint: {
      "circle-color": "#64748b",
      "circle-radius": ["step", ["get","point_count"], 16, 10, 22, 30, 28]
    }
  });

  map.addLayer({
    id: "cluster-count",
    type: "symbol",
    source: "bears",
    filter: ["has", "point_count"],
    layout: {
      "text-field": "{point_count_abbreviated}",
      "text-size": 12
    },
    paint: { "text-color": "#fff" }
  });

  map.addLayer({
    id: "sighting",
    type: "circle",
    source: "bears",
    filter: ["all", ["!",["has","point_count"]], ["!",["get","isDamage"]]],
    paint: {
      "circle-radius": 6,
      "circle-color": "#3b82f6",
      "circle-stroke-color": "#fff",
      "circle-stroke-width": 1
    }
  });

  map.addLayer({
    id: "damage",
    type: "circle",
    source: "bears",
    filter: ["all", ["!",["has","point_count"]], ["get","isDamage"]],
    paint: {
      "circle-radius": 9,
      "circle-color": "#ef4444",
      "circle-stroke-color": "#fff",
      "circle-stroke-width": 1.5
    }
  });

  /* ===== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ ===== */
  map.on('click', 'sighting', (e) => {
    const coordinates = e.features[0].geometry.coordinates.slice();
    const titleParts = locations.find(l => l.lat === coordinates[1] && l.lng === coordinates[0])?.title.split("ï½œ") || [];
    
    const id = titleParts[0] || "";
    const place = titleParts[1] || "";
    const type = titleParts[2] || "";
    const date = titleParts[3] || "";
    
    const [year, month, day] = date.split("-");
    const dateStr = date ? `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥` : "æ—¥ä»˜ä¸æ˜";

    new maplibregl.Popup()
      .setLngLat(coordinates)
      .setHTML(`
        <div style="font-family: system-ui; padding: 4px 0;">
          <div style="font-weight: bold; font-size: 14px; margin-bottom: 6px; color: #3b82f6;">ğŸ» ${type}</div>
          <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">ğŸ“ ${place}</div>
          <div style="font-size: 12px; color: #64748b;">ğŸ“… ${dateStr}</div>
        </div>
      `)
      .addTo(map);
  });

  map.on('click', 'damage', (e) => {
    const coordinates = e.features[0].geometry.coordinates.slice();
    const titleParts = locations.find(l => l.lat === coordinates[1] && l.lng === coordinates[0])?.title.split("ï½œ") || [];
    
    const id = titleParts[0] || "";
    const place = titleParts[1] || "";
    const type = titleParts[2] || "";
    const date = titleParts[3] || "";
    
    const [year, month, day] = date.split("-");
    const dateStr = date ? `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥` : "æ—¥ä»˜ä¸æ˜";

    new maplibregl.Popup()
      .setLngLat(coordinates)
      .setHTML(`
        <div style="font-family: system-ui; padding: 4px 0;">
          <div style="font-weight: bold; font-size: 14px; margin-bottom: 6px; color: #ef4444;">ğŸ» ${type}</div>
          <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">ğŸ“ ${place}</div>
          <div style="font-size: 12px; color: #64748b;">ğŸ“… ${dateStr}</div>
        </div>
      `)
      .addTo(map);
  });

  // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å¤‰æ›´
  map.on('mouseenter', 'sighting', () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'sighting', () => { map.getCanvas().style.cursor = ''; });
  map.on('mouseenter', 'damage', () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'damage', () => { map.getCanvas().style.cursor = ''; });

  /* ===== æœˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ ===== */
  document.querySelectorAll("#monthFilter button").forEach(btn => {
    btn.addEventListener("click", () => {
      const selectedMonth = btn.dataset.month;
      currentMonth = selectedMonth;

      document.querySelectorAll("#monthFilter button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      let filter;
      if (selectedMonth === "all") {
        filter = ["all"];
      } else {
        const month = parseInt(selectedMonth, 10);
        filter = ["all", ["==", ["get", "month"], month]];
      }

      map.setFilter("clusters", ["all", ["has", "point_count"], filter]);
      map.setFilter("sighting", ["all", ["!",["has","point_count"]], ["!",["get","isDamage"]], filter]);
      map.setFilter("damage", ["all", ["!",["has","point_count"]], ["get","isDamage"], filter]);

      const filteredData = selectedMonth === "all" 
        ? locations 
        : locations.filter(l => getMonthFromTitle(l.title) === parseInt(selectedMonth, 10));
      updateCounts(filteredData);
    });
  });
});
</script>

</body>
</html>
